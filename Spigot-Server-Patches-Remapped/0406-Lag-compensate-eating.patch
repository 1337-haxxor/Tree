From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Tue, 14 Jan 2020 15:28:28 -0800
Subject: [PATCH] Lag compensate eating

When the server is lagging, players will wait longer when eating.
Change to also use a time check instead if it passes.

diff --git a/src/main/java/net/minecraft/entity/LivingEntity.java b/src/main/java/net/minecraft/entity/LivingEntity.java
index 158175e8b573329dd2dd4670b55f3858aa8c19e0..3c889f9f17d6af72743fb9ea031c4d64a883a81f 100644
--- a/src/main/java/net/minecraft/entity/LivingEntity.java
+++ b/src/main/java/net/minecraft/entity/LivingEntity.java
@@ -213,7 +213,7 @@ public abstract class LivingEntity extends Entity {
     private int field_70773_bE;
     private float field_110151_bq;
     public ItemStack field_184627_bm; // Paper - public
-    protected int field_184628_bn;
+    protected int field_184628_bn; protected final int getEatTimeTicks() { return this.field_184628_bn; } protected final void setEatTimeTicks(int value) { this.field_184628_bn = value; } // Paper - OBFHELPER
     protected int field_184629_bo;
     private BlockPos field_184620_bC;
     private Optional<BlockPos> field_233624_bE_;
@@ -3109,6 +3109,11 @@ public abstract class LivingEntity extends Entity {
         return ((Byte) this.field_70180_af.func_187225_a(LivingEntity.field_184621_as) & 2) > 0 ? Hand.OFF_HAND : Hand.MAIN_HAND;
     }
 
+    // Paper start - lag compensate eating
+    protected long eatStartTime;
+    protected int totalEatTimeTicks;
+    // Paper end
+
     private void func_184608_ct() {
         if (this.func_184587_cr()) {
             if (ItemStack.func_185132_d(this.func_184586_b(this.func_184600_cs()), this.field_184627_bm)) {
@@ -3118,7 +3123,13 @@ public abstract class LivingEntity extends Entity {
                     this.func_226293_b_(this.field_184627_bm, 5);
                 }
 
-                if (--this.field_184628_bn == 0 && !this.field_70170_p.field_72995_K && !this.field_184627_bm.func_222122_m()) {
+                // Paper start - lag compensate eating
+                // we add 1 to the expected time to avoid lag compensating when we should not
+                boolean shouldLagCompensate
+                    = this.field_184627_bm.func_77973_b().func_219971_r() && this.eatStartTime != -1 && (System.nanoTime() - this.eatStartTime) > ((1 + this.totalEatTimeTicks) * 50 * (1000 * 1000));
+                if ((--this.field_184628_bn == 0 || shouldLagCompensate) && !this.field_70170_p.field_72995_K && !this.field_184627_bm.func_222122_m()) {
+                    this.setEatTimeTicks(0);
+                    // Paper end
                     this.func_71036_o();
                 }
             } else {
@@ -3168,7 +3179,10 @@ public abstract class LivingEntity extends Entity {
 
         if (!itemstack.func_190926_b() && !this.func_184587_cr() || forceUpdate) { // Paper use override flag
             this.field_184627_bm = itemstack;
-            this.field_184628_bn = itemstack.func_77988_m();
+            // Paper start - lag compensate eating
+            this.field_184628_bn = this.totalEatTimeTicks = itemstack.func_77988_m();
+            this.eatStartTime = System.nanoTime();
+            // Paper end
             if (!this.field_70170_p.field_72995_K) {
                 this.func_204802_c(1, true);
                 this.func_204802_c(2, enumhand == Hand.OFF_HAND);
@@ -3192,7 +3206,10 @@ public abstract class LivingEntity extends Entity {
                 }
             } else if (!this.func_184587_cr() && !this.field_184627_bm.func_190926_b()) {
                 this.field_184627_bm = ItemStack.field_190927_a;
-                this.field_184628_bn = 0;
+                // Paper start - lag compensate eating
+                this.field_184628_bn = this.totalEatTimeTicks = 0;
+                this.eatStartTime = -1L;
+                // Paper end
             }
         }
 
@@ -3314,7 +3331,10 @@ public abstract class LivingEntity extends Entity {
         }
 
         this.field_184627_bm = ItemStack.field_190927_a;
-        this.field_184628_bn = 0;
+        // Paper start - lag compensate eating
+        this.field_184628_bn = this.totalEatTimeTicks = 0;
+        this.eatStartTime = -1L;
+        // Paper end
     }
 
     public boolean func_184585_cz() {
