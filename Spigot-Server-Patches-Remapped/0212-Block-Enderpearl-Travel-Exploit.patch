From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 30 Apr 2018 17:15:26 -0400
Subject: [PATCH] Block Enderpearl Travel Exploit

Players are able to use alt accounts and enderpearls to travel
long distances utilizing the pearls in unloaded chunks and loading
the chunk later when convenient.

This disables that by not saving the thrower when the chunk is unloaded.

This is mainly useful for survival servers that do not allow freeform teleporting.

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index e3e529c00122eaf04c7085b1074c5dd124419513..0c8160aa7098f117d2a174ffd944741b11818d10 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -357,4 +357,10 @@ public class PaperWorldConfig {
     private void disableSprintInterruptionOnAttack() {
         disableSprintInterruptionOnAttack = getBoolean("game-mechanics.disable-sprint-interruption-on-attack", false);
     }
+
+    public boolean disableEnderpearlExploit = true;
+    private void disableEnderpearlExploit() {
+        disableEnderpearlExploit = getBoolean("game-mechanics.disable-unloaded-chunk-enderpearl-exploit", disableEnderpearlExploit);
+        log("Disable Unloaded Chunk Enderpearl Exploit: " + (disableEnderpearlExploit ? "enabled" : "disabled"));
+    }
 }
diff --git a/src/main/java/net/minecraft/entity/projectile/ProjectileEntity.java b/src/main/java/net/minecraft/entity/projectile/ProjectileEntity.java
index 792e1c8df3503236f6feb80412baab23b34fa65c..b446cf97e969503770d87cc44ccc8ef757e3ac09 100644
--- a/src/main/java/net/minecraft/entity/projectile/ProjectileEntity.java
+++ b/src/main/java/net/minecraft/entity/projectile/ProjectileEntity.java
@@ -6,6 +6,7 @@ import javax.annotation.Nullable;
 import net.minecraft.block.BlockState;
 import net.minecraft.entity.Entity;
 import net.minecraft.entity.EntityType;
+import net.minecraft.entity.item.EnderPearlEntity;
 import net.minecraft.nbt.CompoundNBT;
 import net.minecraft.util.math.BlockRayTraceResult;
 import net.minecraft.util.math.EntityRayTraceResult;
@@ -58,6 +59,7 @@ public abstract class ProjectileEntity extends Entity {
     protected void func_70037_a(CompoundNBT p_70037_1_) {
         if (p_70037_1_.func_186855_b("Owner")) {
             this.field_234609_b_ = p_70037_1_.func_186857_a("Owner");
+            if (this instanceof EnderPearlEntity && this.field_70170_p != null && this.field_70170_p.paperConfig.disableEnderpearlExploit) { this.field_234609_b_ = null; } // Paper - Don't store shooter name for pearls to block enderpearl travel exploit
         }
 
         this.field_234611_d_ = p_70037_1_.func_74767_n("LeftOwner");
