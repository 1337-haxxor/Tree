From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 30 Apr 2018 13:15:55 -0400
Subject: [PATCH] EndermanEscapeEvent

Fires an event anytime an enderman intends to teleport away from the player

You may cancel this, enabling ranged attacks to damage the enderman for example.

diff --git a/src/main/java/net/minecraft/entity/monster/EndermanEntity.java b/src/main/java/net/minecraft/entity/monster/EndermanEntity.java
index cf362db3b9e56b08366968a13bb33d3638051ae2..a3876fabb7d2ba69500c3fcb1c47e0577d748028 100644
--- a/src/main/java/net/minecraft/entity/monster/EndermanEntity.java
+++ b/src/main/java/net/minecraft/entity/monster/EndermanEntity.java
@@ -2,6 +2,7 @@ package net.minecraft.entity.monster;
 
 import java.util.EnumSet;
 import java.util.Optional;
+import com.destroystokyo.paper.event.entity.EndermanEscapeEvent; // Paper
 import java.util.Random;
 import java.util.UUID;
 import java.util.function.Predicate;
@@ -108,6 +109,12 @@ public class EndermanEntity extends MonsterEntity implements IAngerable {
         setGoalTarget(p_70624_1_, org.bukkit.event.entity.EntityTargetEvent.TargetReason.UNKNOWN, true);
     }
 
+    // Paper start
+    private boolean tryEscape(EndermanEscapeEvent.Reason reason) {
+        return new EndermanEscapeEvent((org.bukkit.craftbukkit.entity.CraftEnderman) this.getBukkitEntity(), reason).callEvent();
+    }
+    // Paper end
+
     @Override
     public boolean setGoalTarget(LivingEntity entityliving, org.bukkit.event.entity.EntityTargetEvent.TargetReason reason, boolean fireEvent) {
         if (!super.setGoalTarget(entityliving, reason, fireEvent)) {
@@ -261,7 +268,7 @@ public class EndermanEntity extends MonsterEntity implements IAngerable {
         if (this.field_70170_p.func_72935_r() && this.field_70173_aa >= this.field_184721_by + 600) {
             float f = this.func_70013_c();
 
-            if (f > 0.5F && this.field_70170_p.func_226660_f_(this.func_233580_cy_()) && this.field_70146_Z.nextFloat() * 30.0F < (f - 0.4F) * 2.0F) {
+            if (f > 0.5F && this.field_70170_p.func_226660_f_(this.func_233580_cy_()) && this.field_70146_Z.nextFloat() * 30.0F < (f - 0.4F) * 2.0F && this.tryEscape(EndermanEscapeEvent.Reason.RUNAWAY)) { // Paper
                 this.func_70624_b((LivingEntity) null);
                 this.func_70820_n();
             }
@@ -359,17 +366,19 @@ public class EndermanEntity extends MonsterEntity implements IAngerable {
         if (this.func_180431_b(p_70097_1_)) {
             return false;
         } else if (p_70097_1_ instanceof IndirectEntityDamageSource) {
+            if (this.tryEscape(EndermanEscapeEvent.Reason.INDIRECT)) { // Paper start
             for (int i = 0; i < 64; ++i) {
                 if (this.func_70820_n()) {
                     return true;
                 }
             }
+            } // Paper end
 
             return false;
         } else {
             boolean flag = super.func_70097_a(p_70097_1_, p_70097_2_);
 
-            if (!this.field_70170_p.func_201670_d() && this.field_70146_Z.nextInt(10) != 0) {
+            if (!this.field_70170_p.func_201670_d() && this.field_70146_Z.nextInt(10) != 0 && this.tryEscape(p_70097_1_ == DamageSource.field_76369_e ? EndermanEscapeEvent.Reason.DROWN : EndermanEscapeEvent.Reason.CRITICAL_HIT)) { // Paper
                 this.func_70820_n();
             }
 
@@ -511,7 +520,7 @@ public class EndermanEntity extends MonsterEntity implements IAngerable {
 
     static class FindPlayerGoal extends NearestAttackableTargetGoal<PlayerEntity> {
 
-        private final EndermanEntity field_179449_j;
+        private final EndermanEntity field_179449_j; public final EndermanEntity getEnderman() { return this.field_179449_j; } // Paper - OBFHELPER
         private PlayerEntity field_179448_g;
         private int field_179450_h;
         private int field_179451_i;
@@ -574,7 +583,7 @@ public class EndermanEntity extends MonsterEntity implements IAngerable {
             } else {
                 if (this.field_75309_a != null && !this.field_179449_j.func_184218_aH()) {
                     if (this.field_179449_j.func_70821_d((PlayerEntity) this.field_75309_a)) {
-                        if (this.field_75309_a.func_70068_e((Entity) this.field_179449_j) < 16.0D) {
+                        if (this.field_75309_a.func_70068_e((Entity) this.field_179449_j) < 16.0D && this.getEnderman().tryEscape(EndermanEscapeEvent.Reason.STARE)) {
                             this.field_179449_j.func_70820_n();
                         }
 
