From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 22 Jan 2017 18:07:56 -0500
Subject: [PATCH] Cap Entity Collisions

Limit a single entity to colliding a max of configurable times per tick.
This will alleviate issues where living entities are hoarded in 1x1 pens

This is not tied to the maxEntityCramming rule. Cramming will still apply
just as it does in Vanilla, but entity pushing logic will be capped.

You can set this to 0 to disable collisions.

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 255b4081314162cbe344b008158c6f4584795fb8..04ee0856a8c62e1afb438d4fddf40e605e82a074 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -317,4 +317,10 @@ public class PaperWorldConfig {
             log("Treasure Maps will return already discovered locations");
         }
     }
+
+    public int maxCollisionsPerEntity;
+    private void maxEntityCollision() {
+        maxCollisionsPerEntity = getInt( "max-entity-collisions", this.spigotConfig.getInt("max-entity-collisions", 8) );
+        log( "Max Entity Collisions: " + maxCollisionsPerEntity );
+    }
 }
diff --git a/src/main/java/net/minecraft/entity/Entity.java b/src/main/java/net/minecraft/entity/Entity.java
index 19a04d1ff1b8f95a386c771eb5518f030b038e56..3fe086a3bf82712666e68c338901b0a870676ee0 100644
--- a/src/main/java/net/minecraft/entity/Entity.java
+++ b/src/main/java/net/minecraft/entity/Entity.java
@@ -277,6 +277,7 @@ public abstract class Entity implements INameable, ICommandSource, KeyedObject {
     public final org.spigotmc.ActivationRange.ActivationType activationType = org.spigotmc.ActivationRange.initializeEntityActivationType(this);
     public final boolean defaultActivationState;
     public long activatedTick = Integer.MIN_VALUE;
+    protected int numCollisions = 0; // Paper
     public void inactiveTick() { }
     // Spigot end
 
diff --git a/src/main/java/net/minecraft/entity/LivingEntity.java b/src/main/java/net/minecraft/entity/LivingEntity.java
index 9cda5b828e9eeaac820173e0a378c2607be7013d..81ffa0d2bdd97044b1858a4c06fb4eb943e04cad 100644
--- a/src/main/java/net/minecraft/entity/LivingEntity.java
+++ b/src/main/java/net/minecraft/entity/LivingEntity.java
@@ -2869,8 +2869,11 @@ public abstract class LivingEntity extends Entity {
                 }
             }
 
-            for (j = 0; j < list.size(); ++j) {
+            numCollisions = Math.max(0, numCollisions - field_70170_p.paperConfig.maxCollisionsPerEntity); // Paper
+            for (j = 0; j < list.size() && numCollisions < field_70170_p.paperConfig.maxCollisionsPerEntity; ++j) { // Paper
                 Entity entity = (Entity) list.get(j);
+                entity.numCollisions++; // Paper
+                numCollisions++; // Paper
 
                 this.func_82167_n(entity);
             }
