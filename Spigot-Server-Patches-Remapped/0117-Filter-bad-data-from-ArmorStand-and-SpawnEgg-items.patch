From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Zach Brown <zach.brown@destroystokyo.com>
Date: Sat, 12 Nov 2016 23:25:22 -0600
Subject: [PATCH] Filter bad data from ArmorStand and SpawnEgg items


diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 74d0a591d3033b5ea4f2b0be8027d7096de66d8a..64a34e48d55ef94507896982115be438e9632f6e 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -2,6 +2,7 @@ package com.destroystokyo.paper;
 
 import java.util.List;
 
+import org.bukkit.Bukkit;
 import org.bukkit.configuration.file.YamlConfiguration;
 import org.spigotmc.SpigotWorldConfig;
 
@@ -299,4 +300,12 @@ public class PaperWorldConfig {
     private void removeCorruptTEs() {
         removeCorruptTEs = getBoolean("remove-corrupt-tile-entities", false);
     }
+
+    public boolean filterNBTFromSpawnEgg = true;
+    private void fitlerNBTFromSpawnEgg() {
+        filterNBTFromSpawnEgg = getBoolean("filter-nbt-data-from-spawn-eggs-and-related", true);
+        if (!filterNBTFromSpawnEgg) {
+            Bukkit.getLogger().warning("Spawn Egg and Armor Stand NBT filtering disabled, this is a potential security risk");
+        }
+    }
 }
diff --git a/src/main/java/net/minecraft/entity/item/FallingBlockEntity.java b/src/main/java/net/minecraft/entity/item/FallingBlockEntity.java
index 727e362676adf0ed76768513cd0dec88dcec965d..c9ff432ab20b3cc74837b23eca64681db6aaf1ad 100644
--- a/src/main/java/net/minecraft/entity/item/FallingBlockEntity.java
+++ b/src/main/java/net/minecraft/entity/item/FallingBlockEntity.java
@@ -271,6 +271,13 @@ public class FallingBlockEntity extends Entity {
     @Override
     protected void func_70037_a(CompoundNBT p_70037_1_) {
         this.field_175132_d = NBTUtil.func_190008_d(p_70037_1_.func_74775_l("BlockState"));
+        // Paper start - Block FallingBlocks with Command Blocks
+        // Check mappings on update - dc = "repeating_command_block" - dd = "chain_command_block"
+        final Block b = this.field_175132_d.func_177230_c();
+        if (this.field_70170_p.paperConfig.filterNBTFromSpawnEgg && (b == Blocks.field_150483_bI || b == Blocks.field_185776_dc || b == Blocks.field_185777_dd)) {
+            this.field_175132_d = Blocks.field_150348_b.func_176223_P();
+        }
+        // Paper end
         this.field_145812_b = p_70037_1_.func_74762_e("Time");
         if (p_70037_1_.func_150297_b("HurtEntities", 99)) {
             this.field_145809_g = p_70037_1_.func_74767_n("HurtEntities");
