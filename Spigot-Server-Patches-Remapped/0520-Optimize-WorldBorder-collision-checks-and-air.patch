From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Sun, 10 May 2020 22:49:05 -0400
Subject: [PATCH] Optimize WorldBorder collision checks and air


diff --git a/src/main/java/net/minecraft/entity/Entity.java b/src/main/java/net/minecraft/entity/Entity.java
index fc85fad7b2900c88959084c7552e202201fb4864..3bfaffca39ee00dd6c7c9dd8e79d8aa5e568c9d2 100644
--- a/src/main/java/net/minecraft/entity/Entity.java
+++ b/src/main/java/net/minecraft/entity/Entity.java
@@ -107,7 +107,6 @@ import net.minecraft.util.math.ChunkPos;
 import net.minecraft.util.math.MathHelper;
 import net.minecraft.util.math.RayTraceContext;
 import net.minecraft.util.math.RayTraceResult;
-import net.minecraft.util.math.shapes.IBooleanFunction;
 import net.minecraft.util.math.shapes.ISelectionContext;
 import net.minecraft.util.math.shapes.VoxelShape;
 import net.minecraft.util.math.shapes.VoxelShapes;
@@ -949,7 +948,7 @@ public abstract class Entity implements INameable, ICommandSource, KeyedObject {
         AxisAlignedBB axisalignedbb = this.func_174813_aQ();
         ISelectionContext voxelshapecollision = ISelectionContext.func_216374_a(this);
         VoxelShape voxelshape = this.field_70170_p.func_175723_af().func_222521_a();
-        Stream<VoxelShape> stream = VoxelShapes.func_197879_c(voxelshape, VoxelShapes.func_197881_a(axisalignedbb.func_186664_h(1.0E-7D)), IBooleanFunction.field_223238_i_) ? Stream.empty() : Stream.of(voxelshape);
+        Stream<VoxelShape> stream = !this.field_70170_p.func_175723_af().isInBounds(axisalignedbb) ? Stream.empty() : Stream.of(voxelshape); // Paper
         Stream<VoxelShape> stream1 = this.field_70170_p.func_230318_c_(this, axisalignedbb.func_216361_a(p_213306_1_), (entity) -> {
             return true;
         });
diff --git a/src/main/java/net/minecraft/util/math/shapes/VoxelShapeSpliterator.java b/src/main/java/net/minecraft/util/math/shapes/VoxelShapeSpliterator.java
index da35914845b32da72d34c742e72f5a632a4881cb..99e5c5f1902a48ebcc5288a75be19e9f380e6696 100644
--- a/src/main/java/net/minecraft/util/math/shapes/VoxelShapeSpliterator.java
+++ b/src/main/java/net/minecraft/util/math/shapes/VoxelShapeSpliterator.java
@@ -141,10 +141,10 @@ public class VoxelShapeSpliterator extends AbstractSpliterator<VoxelShape> {
         AxisAlignedBB axisalignedbb = this.field_234868_a_.func_174813_aQ();
 
         if (!func_234877_a_(worldborder, axisalignedbb)) {
-            VoxelShape voxelshape = worldborder.func_222521_a();
-
-            if (!func_241461_b_(voxelshape, axisalignedbb) && func_241460_a_(voxelshape, axisalignedbb)) {
-                p_234879_1_.accept(voxelshape);
+            // Paper start
+            if (worldborder.isInBounds(axisalignedbb.func_186664_h(1.0E-7D)) && !worldborder.isInBounds(axisalignedbb.grow(1.0E-7D))) {
+                p_234879_1_.accept(worldborder.asVoxelShape());
+            // Paper end
                 return true;
             }
         }
diff --git a/src/main/java/net/minecraft/util/math/shapes/VoxelShapes.java b/src/main/java/net/minecraft/util/math/shapes/VoxelShapes.java
index 4aff71693da0f9b33169ba750e5115a801ebd1a1..89aac9a2330a9869ccd30b0d2a7795b7ba80031a 100644
--- a/src/main/java/net/minecraft/util/math/shapes/VoxelShapes.java
+++ b/src/main/java/net/minecraft/util/math/shapes/VoxelShapes.java
@@ -252,7 +252,7 @@ public final class VoxelShapes {
                                 BlockState iblockdata = p_216386_1_.getTypeIfLoaded(blockposition_mutableblockposition); // Paper
                                 if (iblockdata == null) return 0.0D; // Paper
 
-                                if ((k2 != 1 || iblockdata.func_215704_f()) && (k2 != 2 || iblockdata.func_203425_a(Blocks.field_196603_bb))) {
+                                if (!iblockdata.func_196958_f() && (k2 != 1 || iblockdata.func_215704_f()) && (k2 != 2 || iblockdata.func_203425_a(Blocks.field_196603_bb))) { // Paper
                                     p_216386_2_ = iblockdata.func_215685_b((IBlockReader) p_216386_1_, blockposition_mutableblockposition, p_216386_3_).func_212430_a(enumdirection_enumaxis2, p_216386_0_.func_72317_d((double) (-blockposition_mutableblockposition.func_177958_n()), (double) (-blockposition_mutableblockposition.func_177956_o()), (double) (-blockposition_mutableblockposition.func_177952_p())), p_216386_2_);
                                     if (Math.abs(p_216386_2_) < 1.0E-7D) {
                                         return 0.0D;
diff --git a/src/main/java/net/minecraft/world/border/WorldBorder.java b/src/main/java/net/minecraft/world/border/WorldBorder.java
index e1ee7157a59a443718539cbcf165b08dae41b3f9..85e772f0ec9a312537410d2e7c0f67898fbbc0f6 100644
--- a/src/main/java/net/minecraft/world/border/WorldBorder.java
+++ b/src/main/java/net/minecraft/world/border/WorldBorder.java
@@ -53,6 +53,7 @@ public class WorldBorder {
         return (double) p_177730_1_.func_180332_e() > this.func_177726_b() && (double) p_177730_1_.func_180334_c() < this.func_177728_d() && (double) p_177730_1_.func_180330_f() > this.func_177736_c() && (double) p_177730_1_.func_180333_d() < this.func_177733_e();
     }
 
+    public final boolean isInBounds(AxisAlignedBB aabb) { return this.func_177743_a(aabb); } // Paper - OBFHELPER
     public boolean func_177743_a(AxisAlignedBB p_177743_1_) {
         return p_177743_1_.field_72336_d > this.func_177726_b() && p_177743_1_.field_72340_a < this.func_177728_d() && p_177743_1_.field_72334_f > this.func_177736_c() && p_177743_1_.field_72339_c < this.func_177733_e();
     }
