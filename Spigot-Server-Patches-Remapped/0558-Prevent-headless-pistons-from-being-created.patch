From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: commandblockguy <commandblockguy1@gmail.com>
Date: Fri, 14 Aug 2020 14:44:14 -0500
Subject: [PATCH] Prevent headless pistons from being created

Prevent headless pistons from being created by explosions or tree/mushroom growth.

diff --git a/src/main/java/com/destroystokyo/paper/PaperConfig.java b/src/main/java/com/destroystokyo/paper/PaperConfig.java
index d86474a1a97597c14ea8a28444e2a5d82fcda2a7..e0422471776f34b8e3c753d855aa06f00cc049ec 100644
--- a/src/main/java/com/destroystokyo/paper/PaperConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperConfig.java
@@ -436,6 +436,12 @@ public class PaperConfig {
         set("settings.unsupported-settings.allow-tnt-duplication", null);
     }
 
+    public static boolean allowHeadlessPistons;
+    private static void allowHeadlessPistons() {
+        config.set("settings.unsupported-settings.allow-headless-pistons-readme", "This setting controls if players should be able to create headless pistons.");
+        allowHeadlessPistons = getBoolean("settings.unsupported-settings.allow-headless-pistons", false);
+    }
+
     public static int playerAutoSaveRate = -1;
     public static int maxPlayerAutoSavePerTick = 10;
     private static void playerAutoSaveRate() {
diff --git a/src/main/java/net/minecraft/tileentity/PistonTileEntity.java b/src/main/java/net/minecraft/tileentity/PistonTileEntity.java
index e99c757c4c6ca3835fd8c9e0401d5061bf855c32..0bd95b5f682c352cab5a0f1073cd2263fa0ec0d4 100644
--- a/src/main/java/net/minecraft/tileentity/PistonTileEntity.java
+++ b/src/main/java/net/minecraft/tileentity/PistonTileEntity.java
@@ -65,6 +65,8 @@ public class PistonTileEntity extends TileEntity implements ITickableTileEntity
         return this.field_174931_f;
     }
 
+    public final boolean isHead() { return this.func_145867_d(); } // Paper - OBFHELPER
+
     public boolean func_145867_d() {
         return this.field_145872_l;
     }
diff --git a/src/main/java/net/minecraft/world/Explosion.java b/src/main/java/net/minecraft/world/Explosion.java
index 7b540e71847eb951e7a69864a79017910280e121..7fdc980798ef45c6579416447816df1b98cb7c6c 100644
--- a/src/main/java/net/minecraft/world/Explosion.java
+++ b/src/main/java/net/minecraft/world/Explosion.java
@@ -18,6 +18,7 @@ import net.minecraft.block.AbstractFireBlock;
 import net.minecraft.block.Block;
 import net.minecraft.block.BlockState;
 import net.minecraft.block.Blocks;
+import net.minecraft.block.PistonHeadBlock;
 import net.minecraft.enchantment.ProtectionEnchantment;
 import net.minecraft.entity.Entity;
 import net.minecraft.entity.LivingEntity;
@@ -31,8 +32,10 @@ import net.minecraft.item.ItemStack;
 import net.minecraft.loot.LootContext;
 import net.minecraft.loot.LootParameters;
 import net.minecraft.particles.ParticleTypes;
+import net.minecraft.tileentity.PistonTileEntity;
 import net.minecraft.tileentity.TileEntity;
 import net.minecraft.util.DamageSource;
+import net.minecraft.util.Direction;
 import net.minecraft.util.SoundCategory;
 import net.minecraft.util.SoundEvents;
 import net.minecraft.util.math.AxisAlignedBB;
@@ -163,6 +166,15 @@ public class Explosion {
 
                             if (f > 0.0F && this.field_234893_k_.func_230311_a_(this, this.field_77287_j, blockposition, iblockdata, f) && blockposition.func_177956_o() < 256 && blockposition.func_177956_o() >= 0) { // CraftBukkit - don't wrap explosions
                                 set.add(blockposition);
+                                // Paper start - prevent headless pistons from forming
+                                if (!com.destroystokyo.paper.PaperConfig.allowHeadlessPistons && iblockdata.func_177230_c() == Blocks.field_196603_bb) {
+                                    PistonTileEntity extension = (PistonTileEntity)this.field_77287_j.func_175625_s(blockposition);
+                                    if (extension.isHead()) {
+                                       Direction direction = iblockdata.func_177229_b(PistonHeadBlock.field_176387_N);
+                                       set.add(blockposition.func_177972_a(direction.func_176734_d()));
+                                    }
+                                }
+                                // Paper end
                             }
 
                             d4 += d0 * 0.30000001192092896D;
