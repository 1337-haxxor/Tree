From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Thu, 11 Jun 2020 17:29:42 -0700
Subject: [PATCH] Fix piston physics inconsistency - MC-188840

Pistons invoke physics when they move blocks. The physics can cause
tnt blocks to ignite. However, pistons (when storing the blocks they "moved")
don't actually go back to the world state sometimes to check if something
like that happened. As a result they end up moving the tnt like it was
never ignited. This resulted in the ability to create machines
that can duplicate tnt, called "world eaters".
This patch makes the piston logic retrieve the block state from the world
prevent this from occuring.

This patch also sets the moved pos to air immediately after creating
the moving piston TE. This prevents the block from being updated from
other physics calls by the piston.

Tested against the following tnt duper design:
https://www.youtube.com/watch?v=mS7xxNGhjxs

This patch also affects every type of machine that utilises
this mechanic. For example, dead coral is removed by a physics
update when being moved while it is attached to slimeblocks.

Standard piston machines that don't destroy or modify the
blocks they move by physics updates should be entirely
unaffected.

This patch fixes https://bugs.mojang.com/browse/MC-188840

This patch also fixes rail duping and carpet duping.

diff --git a/src/main/java/com/destroystokyo/paper/PaperConfig.java b/src/main/java/com/destroystokyo/paper/PaperConfig.java
index f2f0b9f011bf5b5aa7d80c605cc885104bb934f8..56e4359ba32339e1bef58061585ff3e12e4215f3 100644
--- a/src/main/java/com/destroystokyo/paper/PaperConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperConfig.java
@@ -429,4 +429,10 @@ public class PaperConfig {
         consoleHasAllPermissions = getBoolean("settings.console-has-all-permissions", consoleHasAllPermissions);
     }
 
+    public static boolean allowPistonDuplication;
+    private static void allowPistonDuplication() {
+        config.set("settings.unsupported-settings.allow-piston-duplication-readme", "This setting controls if player should be able to use TNT duplication, but this also allows duplicating carpet, rails and potentially other items");
+        allowPistonDuplication = getBoolean("settings.unsupported-settings.allow-piston-duplication", config.getBoolean("settings.unsupported-settings.allow-tnt-duplication", false));
+        set("settings.unsupported-settings.allow-tnt-duplication", null);
+    }
 }
diff --git a/src/main/java/net/minecraft/block/PistonBlock.java b/src/main/java/net/minecraft/block/PistonBlock.java
index 1862dd5c477ebf207f5b4599122b12d2824db20e..f95e9423db176180da16c11982c42f268d283832 100644
--- a/src/main/java/net/minecraft/block/PistonBlock.java
+++ b/src/main/java/net/minecraft/block/PistonBlock.java
@@ -391,12 +391,24 @@ public class PistonBlock extends DirectionalBlock {
             }
 
             for (k = list.size() - 1; k >= 0; --k) {
-                blockposition3 = (BlockPos) list.get(k);
-                iblockdata1 = p_176319_1_.func_180495_p(blockposition3);
+                // Paper start - fix a variety of piston desync dupes
+                boolean allowDesync = com.destroystokyo.paper.PaperConfig.allowPistonDuplication;
+                BlockPos oldPos = blockposition3 = (BlockPos) list.get(k);
+                iblockdata1 = allowDesync ? p_176319_1_.func_180495_p(oldPos) : null;
+                // Paper end - fix a variety of piston desync dupes
                 blockposition3 = blockposition3.func_177972_a(enumdirection1);
                 map.remove(blockposition3);
                 p_176319_1_.func_180501_a(blockposition3, (BlockState) Blocks.field_196603_bb.func_176223_P().func_206870_a(PistonBlock.field_176387_N, p_176319_3_), 68);
-                p_176319_1_.func_175690_a(blockposition3, MovingPistonBlock.func_196343_a((BlockState) list1.get(k), p_176319_3_, p_176319_4_, false));
+                // Paper start - fix a variety of piston desync dupes
+                if (!allowDesync) {
+                    iblockdata1 = p_176319_1_.func_180495_p(oldPos);
+                    map.replace(oldPos, iblockdata1);
+                }
+                p_176319_1_.func_175690_a(blockposition3, MovingPistonBlock.func_196343_a(allowDesync ? list1.get(k) : iblockdata1, p_176319_3_, p_176319_4_, false));
+                if (!allowDesync) {
+                    p_176319_1_.func_180501_a(oldPos, Blocks.field_150350_a.func_176223_P(), 2 | 4 | 16 | 1024); // set air to prevent later physics updates from seeing this block
+                }
+                // Paper end - fix a variety of piston desync dupes
                 aiblockdata[j++] = iblockdata1;
             }
 
diff --git a/src/main/java/net/minecraft/tileentity/PistonTileEntity.java b/src/main/java/net/minecraft/tileentity/PistonTileEntity.java
index 89a023026fdce400afedf92538d2b271307d51b5..c1c2ceac33f34ee23f9c612f683bcbe8072cfc6d 100644
--- a/src/main/java/net/minecraft/tileentity/PistonTileEntity.java
+++ b/src/main/java/net/minecraft/tileentity/PistonTileEntity.java
@@ -280,7 +280,7 @@ public class PistonTileEntity extends TileEntity implements ITickableTileEntity
                 BlockState iblockdata = Block.func_199770_b(this.field_200231_a, (IWorld) this.field_145850_b, this.field_174879_c);
 
                 if (iblockdata.func_196958_f()) {
-                    this.field_145850_b.func_180501_a(this.field_174879_c, this.field_200231_a, 84);
+                    this.field_145850_b.func_180501_a(this.field_174879_c, this.field_200231_a, com.destroystokyo.paper.PaperConfig.allowPistonDuplication ? 84 : (84 | 2)); // Paper - force notify (flag 2), it's possible the set type by the piston block (which doesn't notify) set this block to air
                     Block.func_196263_a(this.field_200231_a, iblockdata, this.field_145850_b, this.field_174879_c, 3);
                 } else {
                     if (iblockdata.func_235901_b_(BlockStateProperties.field_208198_y) && (Boolean) iblockdata.func_177229_b(BlockStateProperties.field_208198_y)) {
