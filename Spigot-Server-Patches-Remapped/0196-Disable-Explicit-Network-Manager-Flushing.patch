From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 11 Mar 2018 14:13:33 -0400
Subject: [PATCH] Disable Explicit Network Manager Flushing

This seems completely pointless, as packet dispatch uses .writeAndFlush.

Things seem to work fine without explicit flushing, but incase issues arise,
provide a System property to re-enable it using improved logic of doing the
flushing on the netty event loop, so it won't do the flush on the main thread.

Renable flushing by passing -Dpaper.explicit-flush=true

diff --git a/src/main/java/net/minecraft/network/NetworkManager.java b/src/main/java/net/minecraft/network/NetworkManager.java
index 80bba2efce688173ad92dbfffc286abf316e011a..f11483fd001648c89c149c2f2622f443cb66b007 100644
--- a/src/main/java/net/minecraft/network/NetworkManager.java
+++ b/src/main/java/net/minecraft/network/NetworkManager.java
@@ -71,6 +71,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<IPacket<?>> {
     // Paper start - NetworkClient implementation
     public int protocolVersion;
     public java.net.InetSocketAddress virtualHost;
+    private static boolean enableExplicitFlush = Boolean.getBoolean("paper.explicit-flush");
     // Paper end
 
     public NetworkManager(PacketDirection enumprotocoldirection) {
@@ -238,7 +239,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<IPacket<?>> {
         }
 
         if (this.field_150746_k != null) {
-            this.field_150746_k.flush();
+            if (enableExplicitFlush) this.field_150746_k.eventLoop().execute(() -> this.field_150746_k.flush()); // Paper - we don't need to explicit flush here, but allow opt in incase issues are found to a better version
         }
 
         if (this.field_211398_u++ % 20 == 0) {
