From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mariell Hoversholm <proximyst@proximyst.com>
Date: Thu, 30 Apr 2020 16:56:54 +0200
Subject: [PATCH] Add Raw Byte ItemStack Serialization

Serializes using NBT which is safer for server data migrations than bukkits format.

diff --git a/src/main/java/net/minecraft/item/ItemStack.java b/src/main/java/net/minecraft/item/ItemStack.java
index 89ffe15fe2ebbdcb91be05a9109c934b12f239d6..b0ef59a2b35aec2d16f9006ecc231baf602524f3 100644
--- a/src/main/java/net/minecraft/item/ItemStack.java
+++ b/src/main/java/net/minecraft/item/ItemStack.java
@@ -197,6 +197,7 @@ public final class ItemStack {
         this.func_190923_F();
     }
 
+    public static ItemStack fromCompound(CompoundNBT nbttagcompound) { return func_199557_a(nbttagcompound); } // Paper - OBFHELPER
     public static ItemStack func_199557_a(CompoundNBT p_199557_0_) {
         try {
             return new ItemStack(p_199557_0_);
diff --git a/src/main/java/net/minecraft/nbt/CompressedStreamTools.java b/src/main/java/net/minecraft/nbt/CompressedStreamTools.java
index 8d4d7f20d51e664444f30ad6f27d3113ab5fedd6..55c58a5a7a9679fae86ac29c80a3092eeea6b233 100644
--- a/src/main/java/net/minecraft/nbt/CompressedStreamTools.java
+++ b/src/main/java/net/minecraft/nbt/CompressedStreamTools.java
@@ -18,6 +18,7 @@ import io.netty.buffer.ByteBufInputStream; // Paper
 
 public class CompressedStreamTools {
 
+    public static CompoundNBT readNBT(InputStream inputstream) throws IOException { return func_74796_a(inputstream); } // Paper - OBFHELPER
     public static CompoundNBT func_74796_a(InputStream p_74796_0_) throws IOException {
         DataInputStream datainputstream = new DataInputStream(new BufferedInputStream(new GZIPInputStream(p_74796_0_)));
         Throwable throwable = null;
@@ -47,6 +48,7 @@ public class CompressedStreamTools {
         return nbttagcompound;
     }
 
+    public static void writeNBT(CompoundNBT nbttagcompound, OutputStream outputstream) throws IOException { func_74799_a(nbttagcompound, outputstream); } // Paper - OBFHELPER
     public static void func_74799_a(CompoundNBT p_74799_0_, OutputStream p_74799_1_) throws IOException {
         DataOutputStream dataoutputstream = new DataOutputStream(new BufferedOutputStream(new GZIPOutputStream(p_74799_1_)));
         Throwable throwable = null;
diff --git a/src/main/java/net/minecraft/util/datafix/DataFixesManager.java b/src/main/java/net/minecraft/util/datafix/DataFixesManager.java
index 7f1ce5ab28e36479ddf97b1b2ef48987979aa610..22ceb7cfd88074023b82394fb8bbc5ea6f0315fa 100644
--- a/src/main/java/net/minecraft/util/datafix/DataFixesManager.java
+++ b/src/main/java/net/minecraft/util/datafix/DataFixesManager.java
@@ -76,6 +76,7 @@ public class DataFixesManager {
         return datafixerbuilder.build(Util.func_240991_e_());
     }
 
+    public static DataFixer getDataFixer() { return func_210901_a(); } // Paper - OBFHELPER
     public static DataFixer func_210901_a() {
         return DataFixesManager.field_210902_d;
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java b/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java
index 651f0ab4c653ca03ab3375f0febf077c87d39d1e..28a6dcb5f2cfc2cdeebbe4a41c0e8ae26ee158a4 100644
--- a/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java
+++ b/src/main/java/org/bukkit/craftbukkit/util/CraftMagicNumbers.java
@@ -333,6 +333,46 @@ public final class CraftMagicNumbers implements UnsafeValues {
     public boolean isSupportedApiVersion(String apiVersion) {
         return apiVersion != null && SUPPORTED_API.contains(apiVersion);
     }
+
+    @Override
+    public byte[] serializeItem(ItemStack item) {
+        Preconditions.checkNotNull(item, "null cannot be serialized");
+        Preconditions.checkArgument(item.getType() != Material.AIR, "air cannot be serialized");
+
+        java.io.ByteArrayOutputStream outputStream = new java.io.ByteArrayOutputStream();
+        CompoundNBT compound = (item instanceof CraftItemStack ? ((CraftItemStack) item).getHandle() : CraftItemStack.asNMSCopy(item)).func_77955_b(new CompoundNBT());
+        compound.func_74768_a("DataVersion", getDataVersion());
+        try {
+            net.minecraft.nbt.CompressedStreamTools.writeNBT(
+                compound,
+                outputStream
+            );
+        } catch (IOException ex) {
+            throw new RuntimeException(ex);
+        }
+
+        return outputStream.toByteArray();
+    }
+
+    @Override
+    public ItemStack deserializeItem(byte[] data) {
+        Preconditions.checkNotNull(data, "null cannot be deserialized");
+        Preconditions.checkArgument(data.length > 0, "cannot deserialize nothing");
+
+        try {
+            CompoundNBT compound = net.minecraft.nbt.CompressedStreamTools.readNBT(
+                new java.io.ByteArrayInputStream(data)
+            );
+            int dataVersion = compound.func_74762_e("DataVersion");
+
+            Preconditions.checkArgument(dataVersion <= getDataVersion(), "Newer version! Server downgrades are not supported!");
+            Dynamic<INBT> converted = DataFixesManager.getDataFixer().update(TypeReferences.field_211295_k, new Dynamic<INBT>(NBTDynamicOps.field_210820_a, compound), dataVersion, getDataVersion());
+            return CraftItemStack.asCraftMirror(net.minecraft.item.ItemStack.fromCompound((CompoundNBT) converted.getValue()));
+        } catch (IOException ex) {
+            com.destroystokyo.paper.util.SneakyThrow.sneaky(ex);
+            throw new RuntimeException();
+        }
+    }
     // Paper end
 
     /**
