From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Sat, 25 Jan 2020 17:04:35 -0800
Subject: [PATCH] Optimise getChunkAt calls for loaded chunks

bypass the need to get a player chunk, then get the either,
then unwrap it...

diff --git a/src/main/java/net/minecraft/world/server/ServerChunkProvider.java b/src/main/java/net/minecraft/world/server/ServerChunkProvider.java
index 9bb34ba665ab034e90abb3946d1be5f9de1c1d7a..d3a77f975c53f0dabe8f4f5aafac8a7452a6301d 100644
--- a/src/main/java/net/minecraft/world/server/ServerChunkProvider.java
+++ b/src/main/java/net/minecraft/world/server/ServerChunkProvider.java
@@ -477,6 +477,12 @@ public class ServerChunkProvider extends AbstractChunkProvider {
                 return this.func_212849_a_(p_212849_1_, p_212849_2_, p_212849_3_, p_212849_4_);
             }, this.field_217243_i).join();
         } else {
+            // Paper start - optimise for loaded chunks
+            Chunk ifLoaded = this.getChunkAtIfLoadedMainThread(p_212849_1_, p_212849_2_);
+            if (ifLoaded != null) {
+                return ifLoaded;
+            }
+            // Paper end
             IProfiler gameprofilerfiller = this.field_73251_h.func_217381_Z();
 
             gameprofilerfiller.func_230035_c_("getChunk");
@@ -527,39 +533,7 @@ public class ServerChunkProvider extends AbstractChunkProvider {
         if (Thread.currentThread() != this.field_217241_g) {
             return null;
         } else {
-            this.field_73251_h.func_217381_Z().func_230035_c_("getChunkNow");
-            long k = ChunkPos.func_77272_a(p_225313_1_, p_225313_2_);
-
-            for (int l = 0; l < 4; ++l) {
-                if (k == this.field_222875_n[l] && this.field_222876_o[l] == ChunkStatus.field_222617_m) {
-                    IChunk ichunkaccess = this.field_222877_p[l];
-
-                    return ichunkaccess instanceof Chunk ? (Chunk) ichunkaccess : null;
-                }
-            }
-
-            ChunkHolder playerchunk = this.func_217213_a(k);
-
-            if (playerchunk == null) {
-                return null;
-            } else {
-                Either<IChunk, ChunkHolder.IChunkLoadingError> either = (Either) playerchunk.func_225410_b(ChunkStatus.field_222617_m).getNow(null); // CraftBukkit - decompile error
-
-                if (either == null) {
-                    return null;
-                } else {
-                    IChunk ichunkaccess1 = (IChunk) either.left().orElse(null); // CraftBukkit - decompile error
-
-                    if (ichunkaccess1 != null) {
-                        this.func_225315_a(k, ichunkaccess1, ChunkStatus.field_222617_m);
-                        if (ichunkaccess1 instanceof Chunk) {
-                            return (Chunk) ichunkaccess1;
-                        }
-                    }
-
-                    return null;
-                }
-            }
+            return this.getChunkAtIfLoadedMainThread(p_225313_1_, p_225313_2_); // Paper - optimise for loaded chunks
         }
     }
 
